#!/bin/bash

# Get notification count
get_notification_count() {
    if makoctl list &>/dev/null; then
        active_count=$(makoctl list | jq '.data | length')
        history_count=$(makoctl history | jq '.data | length')
        
        total_count=$((active_count + history_count))
        
        if [ "$total_count" -gt 0 ] && [ "$total_count" != "null" ] && [ "$total_count" != "0" ]; then
            echo "{\"text\": \"$total_count\", \"tooltip\": \"$total_count notifications\", \"alt\": \"notification\"}"
        else
            echo "{\"text\": \"\", \"tooltip\": \"No notifications\", \"alt\": \"none\"}"
        fi
    else
        echo "{\"text\": \"\", \"tooltip\": \"No notifications\", \"alt\": \"none\"}"
    fi
}

# Get tooltip with recent notifications
get_tooltip() {
    makoctl list | jq -r '.data[] | .summary' | head -n 5 | sed ':a;N;$!ba;s/\n/\\n/g'
}

# Handle clicks
case $1 in
    "count")
        get_notification_count
        ;;
    "tooltip")
        get_tooltip
        ;;
    "show")
        if makoctl list &>/dev/null; then
            # Combine active and history notifications with proper JSON path
            notifications=$( (makoctl list; makoctl history) | jq -s '[.[].data[]][0] | map({summary: .summary.data, body: .body.data, app_icon: (."app-icon".data // "")})')
            count=$(echo "$notifications" | jq '. | length')
            
            if [ "$count" -gt 0 ] && [ "$count" != "null" ]; then
                # Get notifications with icons and pipe to wofi
                selected=$(echo "$notifications" | jq -r '.[] | .app_icon + "\t" + .summary' | wofi --dmenu --cache-file=/dev/null --define "image-size=24" --show-icons)
                
                if [ ! -z "$selected" ]; then
                    # Remove the icon path and tab for matching
                    clean_selected="${selected#*$'\t'}"
                    
                    # Get the notification body using the summary to match
                    notification=$(echo "$notifications" | jq -r ".[] | select(.summary == \"$clean_selected\") | .body")
                    if [ ! -z "$notification" ]; then
                        notify-send "Notification Details" "$notification"
                    else
                        notify-send "Notification Details" "No additional details available"
                    fi
                fi
            else
                notify-send "No Notifications" "Your notification tray is empty"
            fi
        else
            notify-send "No Notifications" "Your notification tray is empty"
        fi
        ;;
esac
