#!/bin/bash

# Get notification count
get_notification_count() {
    if makoctl list &>/dev/null; then
        active_count=$(makoctl list | jq '.data | length')
        history_count=$(makoctl history | jq '.data | length')
        
        total_count=$((active_count + history_count))
        
        if [ "$total_count" -gt 0 ] && [ "$total_count" != "null" ]; then
            echo "{\"text\": \"$total_count\", \"tooltip\": \"$total_count notifications\", \"alt\": \"notification\"}"
        else
            echo "{\"text\": \"\", \"tooltip\": \"No notifications\", \"alt\": \"none\"}"
        fi
    else
        echo "{\"text\": \"\", \"tooltip\": \"No notifications\", \"alt\": \"none\"}"
    fi
}

# Get tooltip with recent notifications
get_tooltip() {
    makoctl list | jq -r '.data[] | .summary' | head -n 5 | sed ':a;N;$!ba;s/\n/\\n/g'
}

# Handle clicks
case $1 in
    "count")
        get_notification_count
        ;;
    "tooltip")
        get_tooltip
        ;;
    "show")
        if makoctl list &>/dev/null; then
            # Combine active and history notifications
            notifications=$( (makoctl list; makoctl history) | jq -s '.[0].data + .[1].data')
            count=$(echo "$notifications" | jq '. | length')
            
            if [ "$count" -gt 0 ] && [ "$count" != "null" ]; then
                # Get notifications and pipe to wofi
                selected=$(echo "$notifications" | jq -r '.[] | "üìù " + .summary' | wofi --dmenu --cache-file=/dev/null)
                
                if [ ! -z "$selected" ]; then
                    # Remove the emoji prefix for matching
                    clean_selected="${selected#üìù }"
                    
                    # Get the notification body using the summary to match
                    notification=$(echo "$notifications" | jq -r ".[] | select(.summary == \"$clean_selected\") | .body")
                    notify-send "Notification Details" "$notification"
                fi
            else
                notify-send "No Notifications" "Your notification tray is empty"
            fi
        else
            notify-send "No Notifications" "Your notification tray is empty"
        fi
        ;;
esac
